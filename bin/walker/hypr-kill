#!/usr/bin/env bash

set -euxo pipefail

hypr_kill() {
    hyprctl clients -j -i 0 |
        jq -r ".[].address" |
        xargs -I{} hyprctl dispatch -i 0 closewindow address:{}

    local timeout=50
    while ((timeout-- > 0)) && [[ $(hyprctl clients -j -i 0 | jq 'length') -gt 0 ]]; do
        sleep 0.1
    done
    hyprctl dispatch -i 0 workspace 1
}

main() {
    selected="${1:-}"
    if [[ -z $selected ]]; then
        selected=$(echo -e "Shutdown\nReboot" | walker --dmenu)
    fi

    case "${selected,,}" in
    shutdown) hypr_kill && systemctl poweroff -i ;;
    reboot) hypr_kill && systemctl reboot -i ;;
    *) notify-send "hypr-kill" "Not a valid option: \"$selected\"" ;;
    esac
}

main "$@" || notify-send "hypr-kill" "Failed to execute"
