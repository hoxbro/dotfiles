#!/usr/bin/env bash

set -euo pipefail

__hypr_kill() {
    hyprctl clients -j -i 0 |
        jq -r ".[].address" |
        xargs -I{} hyprctl dispatch -i 0 closewindow address:{}

    local timeout=50
    while ((timeout-- > 0)) && [[ $(hyprctl clients -j -i 0 | jq 'length') -gt 0 ]]; do
        sleep 0.1
    done
    hyprctl dispatch -i 0 workspace 1
}

selected="${1:-}"
if [[ -z $selected ]]; then
    selected=$(echo -e "Shutdown\nReboot" | walker --dmenu)
fi

case "${selected,,}" in
shutdown) __hypr_kill && systemctl poweroff -i ;;
reboot) __hypr_kill && systemctl reboot -i ;;
*) exit 1 ;;
esac
