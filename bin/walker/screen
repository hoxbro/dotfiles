#!/usr/bin/env bash

set -euxo pipefail

DATE=$(date +%Y-%m-%d\ %H-%M-%S)
SCREEN_DIR="$HOME/Downloads/screen"
mkdir -p "$SCREEN_DIR"
SCREENSHOT_FILE="$SCREEN_DIR/screenshot-$DATE.png"
SCREENRECORD_FILE="$SCREEN_DIR/screenrecord-$DATE.mp4"
REGION_CACHE="/tmp/walker-screen-region"

if pgrep -f "wf-recorder" >/dev/null; then
    pkill -SIGINT -f "wf-recorder"
    (
        action=$(notify-send "Screen" "Saved screen recording" --action="default=Open Folder" --wait 2>/dev/null)
        if [[ "$action" == "default" ]]; then
            xdg-open "$SCREEN_DIR"
        fi
    ) &
    exit 0
fi

record_screen() {
    devices=$(lspci)
    encoders=$(ffmpeg -hide_banner -encoders 2>&1)

    has_gpu() {
        case "$1" in
        nvidia) grep -Eiq '(vga|3d).*nvidia' <<<"$devices" ;;
        intel) grep -Eiq '(vga|3d).*intel' <<<"$devices" ;;
        amd) grep -Eiq '(vga|3d).*amd' <<<"$devices" ;;
        esac
    }

    has_encoder() { grep -qF -- "$1" <<<"$encoders"; }

    if has_gpu nvidia && has_encoder h264_nvenc; then
        args=(-c h264_nvenc -r 60 -p preset=p4 -p tune=ll -p cq=26)
    elif has_gpu amd && has_encoder h264_vaapi; then
        render_device=$(find /dev/dri -maxdepth 1 -type c -name 'renderD*' -print -quit 2>/dev/null)
        args=(-c h264_vaapi -r 60 -p qp=26 ${render_device:+-d "$render_device"})
    elif has_gpu intel && has_encoder h264_qsv; then
        args=(-c h264_qsv -r 60 -p global_quality=26)
    else
        args=(-c libx264 -r 60 -p crf=23)
    fi

    wf-recorder "${args[@]}" "$@" -f "$SCREENRECORD_FILE"
}

select_region() {
    if [[ -f "$REGION_CACHE" ]]; then
        choice=$(printf '%s\n' "Use Last Region" "Select New Region" | walker --dmenu)
        case "$choice" in
        "Use Last Region") cat "$REGION_CACHE" ;;
        "Select New Region") slurp | tee "$REGION_CACHE" ;;
        *) exit 1 ;;
        esac
    else
        slurp | tee "$REGION_CACHE"
    fi
}

select_window() {
    windows=$(hyprctl clients -j | jq -r '.[] | "\(.title) - \(.class)\t\(.address)"')
    selected=$(echo "$windows" | cut -d$'\t' -f1 | walker --dmenu)

    window_data=$(echo "$windows" | grep -F "$selected" | head -n1)
    address=$(echo "$window_data" | cut -d$'\t' -f2)

    hyprctl dispatch focuswindow address:"$address" >/dev/null
    hyprctl activewindow -j | jq -r '"\(.at[0]),\(.at[1]) \(.size[0])x\(.size[1])"'
}

main() {
    if [[ -z "${1-}" ]]; then
        OPTIONS=(
            "Screenshot | Full"
            "Screenshot | Section"
            "Screenshot | Window"
            "Screenrecord | Full"
            "Screenrecord | Section"
            "Screenrecord | Window"
        )
        OPTION=$(printf '%s\n' "${OPTIONS[@]}" | walker --dmenu)
    else
        OPTION=$1
    fi

    case "$OPTION" in
    "Screenrecord | Full") record_screen ;;
    "Screenrecord | Section") record_screen -g "$(select_region)" ;;
    "Screenrecord | Window") record_screen -g "$(select_window)" ;;
    "Screenshot | Full") grim - | tee "$SCREENSHOT_FILE" | wl-copy ;;
    "Screenshot | Section") grim -g "$(select_region)" - | tee "$SCREENSHOT_FILE" | wl-copy ;;
    "Screenshot | Window")
        current_workspace=$(hyprctl activeworkspace -j | jq -r '.id')
        grim -g "$(select_window)" - | tee "$SCREENSHOT_FILE" | wl-copy
        hyprctl dispatch workspace "$current_workspace" >/dev/null
        ;;
    *) notify-send "Screen" "Not a valid option '$OPTION'" ;;
    esac
}

main "$@" || notify-send "Screen" "Failed to execute"
