#!/usr/bin/env bash
set -euo pipefail

# You've hit your limit · resets 1pm (Europe/Copenhagen)
# You've hit your limit · resets Jan 17, 10am (Europe/Copenhagen)

claude_limit_hit() {
    local output reset_hour target_ts
    output=$(timeout 5 claude --print "t" --no-session-persistence 2>&1) || true

    if echo "$output" | grep -qi "You've hit your limit"; then
        reset_hour=$(
            echo "$output" | sed -n 's/.*resets \([^()]*[0-9]\{1,2\}[ap]m\).*/\1/ip'
        )

        if [[ "$reset_hour" =~ [A-Za-z]{3}[[:space:]][0-9]{1,2} ]]; then
            echo "Claude limit reset is days away: $reset_hour"
            exit 0
        elif [[ -n "$reset_hour" ]]; then
            now_ts=$(date +%s)
            target_ts=$(date -d "$reset_hour" +%s)
            if ((target_ts <= now_ts)); then
                target_ts=$(date -d "tomorrow ${reset_hour}" +%s)
            fi
            echo "$target_ts"
            return 0
        fi
        return 1
    fi

    return 1
}

if target_ts=$(claude_limit_hit); then
    printf 'Claude limit reached — sleeping until %s\n' "$(date -d "@$target_ts" +'%H:%M')"
    while :; do
        sleep_seconds=$((target_ts - $(date +%s) + 5))
        if [ "$sleep_seconds" -le 0 ]; then
            printf '\rDone.%-40s\n' ''
            break
        fi

        printf '\rRemaining: %6ss ' "$sleep_seconds"
        sleep 1
    done
fi

echo "Launching Claude..."
claude --permission-mode acceptEdits --continue "continue"
