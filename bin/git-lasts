#!/usr/bin/env bash

set -euo pipefail

base_branch=$(cat "$(git rev-parse --show-cdup).git/refs/remotes/origin/HEAD" | awk '{print $2}')
branches=$(git reflog --format='%gD %gs' | awk '$2=="checkout:" && $3=="moving" && $4=="from"{print $5}' | awk '!seen[$0]++')

log_cmd="git log --color=always --format='%C(bold yellow)%h %C(cyan)(%ar) %C(green)%an %C(dim white)%s %C(auto)%d' $base_branch..{1}"
diff_cmd="git diff --color=always $base_branch...{1} | diff-so-fancy"
toggle_cmd="[[ \$FZF_PREVIEW_LABEL =~ 'diff' ]] && $diff_cmd || $log_cmd"

branch=$(
  echo "$branches" | fzf --ansi -- --layout=reverse --multi --height=60% --min-height=20 \
    --border-label-pos=2 --border-label 'Branches [C-O diff | C-I log | C-Y clipboard]' --border \
    --no-hscroll --no-multi \
    --preview-window='right,70%,border-left' \
    --preview-label='log' \
    --preview="$toggle_cmd" \
    --bind 'ctrl-o:change-preview-label(diff)+refresh-preview' \
    --bind 'ctrl-i:change-preview-label(log)+refresh-preview' \
    --bind "ctrl-y:execute-silent(printf '%s' {} | copy)"
)

[[ -n $branch ]] && git checkout "$branch"
